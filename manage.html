<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>340 Rentals VI â€“ Manage Listings</title>
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header class="navbar">
  <div class="logo">340 Rentals VI</div>
  <nav>
    <a href="index.html" class="btn">Home</a>
    <a href="rentals.html" class="btn">Rentals</a>
    <a href="contact.html" class="btn">Contact</a>
    <a href="admin.html" class="btn" id="adminLink" style="display:none;">Manage Listings</a>


    <span id="userInfo" class="userInfo" style="display:none;"></span>
    <a id="loginBtn" class="btn" href="#" onclick="startLogin(event)">Owner Login</a>
    <a id="logoutBtn" class="btn" href="#" onclick="startLogout(event)" style="display:none;">Logout</a>
  </nav>
</header>


<main class="content">
  <h1>Manage Listings</h1>

  <!-- This whole block is hidden unless auth says youâ€™re owner/editor -->
  <div id="adminGuard" style="display:none;">
    <form id="propForm" class="prop-form">
      <input type="hidden" id="propId"/>

      <h3>Basic Details</h3>
      <div class="form-row">
        <label style="flex:1; display:flex; flex-direction:column; gap:4px;">
          <span>Title</span>
          <input id="title" placeholder="Title" required />
        </label>
        <label style="flex:1; display:flex; flex-direction:column; gap:4px;">
          <span>Price (USD)</span>
          <input id="price" type="number" placeholder="Price (USD)" required />
        </label>
      </div>

      <div class="form-row">
        <label style="flex:1; display:flex; flex-direction:column; gap:4px;">
          <span>Bedrooms</span>
          <input id="bedrooms" type="number" placeholder="Bedrooms" required />
        </label>
        <label style="flex:1; display:flex; flex-direction:column; gap:4px;">
          <span>Bathrooms</span>
          <input id="bathrooms" type="number" step="0.5" placeholder="Bathrooms" required />
        </label>
      </div>

      <h3>Location</h3>
      <div class="form-row" style="flex-wrap:wrap;">
        <label style="flex:1 1 100%; display:flex; flex-direction:column; gap:4px;">
          <span style="font-weight:bold; color:#222;">Address (used for Google Maps)</span>
          <!-- ðŸ‘‡ THIS IS THE ADDRESS FIELD -->
          <input id="address" type="text" placeholder="e.g. 123 Main St, Charlotte Amalie, St Thomas" />
        </label>

        <label style="flex:1; display:flex; flex-direction:column; gap:4px;">
          <span>City</span>
          <input id="city" type="text" placeholder="City" />
        </label>

        <label style="flex:1; display:flex; flex-direction:column; gap:4px;">
          <span>Sqft</span>
          <input id="sqft" type="number" placeholder="Sqft" />
        </label>
      </div>

      <label class="chk" style="margin-top:6px;">
        <input id="available" type="checkbox" checked/>
        <span>Available</span>
      </label>

      <h3>Description</h3>
      <textarea id="description" placeholder="Description"></textarea>

      <h3>Images</h3>
      <input id="images" placeholder="Image URLs (comma-separated)"/>

      <h3>Tags</h3>
      <input id="tags" placeholder="Tags (comma-separated: pet:allowed,type:house)"/>

      <div class="form-actions">
        <button class="btn primary" type="submit">Save</button>
        <button class="btn" type="button" id="resetBtn">Reset</button>
      </div>
    </form>

    <h2>Current Listings</h2>
    <div id="adminList" class="grid"></div>
  </div>

  <div id="adminDenied" style="display:none;">
    <p>You must be an <strong>owner</strong> or <strong>editor</strong> to access this page.</p>
  </div>
</main>

<script src="script.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // --- Auth guard ---
  const canManage = window.auth?.isOwnerOrEditor?.();
  document.getElementById('adminGuard').style.display = canManage ? 'block' : 'none';
  document.getElementById('adminDenied').style.display = canManage ? 'none' : 'block';

  if (!canManage) return;

  const form      = document.getElementById('propForm');
  const resetBtn  = document.getElementById('resetBtn');
  const adminList = document.getElementById('adminList');

  function parseCSV(s){
    return (s || '')
      .split(',')
      .map(x => x.trim())
      .filter(Boolean);
  }

  function fillForm(p){
    document.getElementById('propId').value      = p?.id || '';
    document.getElementById('title').value       = p?.title || '';
    document.getElementById('price').value       = p?.price ?? '';
    document.getElementById('bedrooms').value    = p?.bedrooms ?? '';
    document.getElementById('bathrooms').value   = p?.bathrooms ?? '';
    document.getElementById('address').value     = p?.address || '';
    document.getElementById('city').value        = p?.city || '';
    document.getElementById('sqft').value        = p?.sqft ?? '';
    document.getElementById('available').checked = p?.available ?? true;
    document.getElementById('description').value = p?.description || '';
    document.getElementById('images').value      = (p?.images || []).join(', ');
    document.getElementById('tags').value        = (p?.tags || []).join(', ');
  }

  function toPayload(){
    return {
      id: document.getElementById('propId').value || undefined,
      title: document.getElementById('title').value.trim(),
      price: Number(document.getElementById('price').value) || 0,
      bedrooms: Number(document.getElementById('bedrooms').value) || 0,
      bathrooms: Number(document.getElementById('bathrooms').value) || 0,
      address: document.getElementById('address').value.trim(),
      city: document.getElementById('city').value.trim(),
      sqft: Number(document.getElementById('sqft').value) || null,
      available: document.getElementById('available').checked,
      description: document.getElementById('description').value.trim(),
      images: parseCSV(document.getElementById('images').value),
      tags: parseCSV(document.getElementById('tags').value),
    };
  }

  function renderCard(p){
    const status = p.available ? 'available' : 'unavailable';
    const tagsHtml = (p.tags || [])
      .slice(0, 6)
      .map(t => `<span class="badge">${t}</span>`)
      .join('');
    const img = (p.images && p.images[0]) || '';
    const address = p.address || '';
    const hasAddress = address.trim().length > 0;
    const mapLink = hasAddress
      ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`
      : '';

    return `
      <div class="card">
        <div class="carousel">
          ${
            img
              ? `<img src="${img}" style="width:100%;height:auto;object-fit:cover;">`
              : '<div style="aspect-ratio:4/3;background:#eee;"></div>'
          }
        </div>
        <div class="card-body" style="padding:0.75rem 1rem;">
          <div class="title-row">
            <div style="font-weight:600;">${p.title || ''}</div>
            <div class="price">$${Number(p.price || 0).toLocaleString()}</div>
          </div>
          <div class="meta">
            ${p.bedrooms || 0} bd â€¢ ${p.bathrooms || 0} ba
            ${p.city ? ' â€¢ ' + p.city : ''}
          </div>
          ${
            hasAddress
              ? `<div style="font-size:12px;color:#666;margin-top:2px;">${address}</div>`
              : ''
          }
          <div style="margin-top:4px;">
            <span class="status ${status}">
              ${p.available ? 'Available' : 'Unavailable'}
            </span>
          </div>
          <p style="font-size:14px;color:#555;margin:.5rem 0 0;">
            ${p.description || ''}
          </p>
          <div class="badges">${tagsHtml}</div>
          <div class="admin-actions">
            <button class="btn" data-act="edit" data-id="${p.id}">Edit</button>
            <button class="btn" data-act="del" data-id="${p.id}">Delete</button>
            ${
              mapLink
                ? `<a class="btn" href="${mapLink}" target="_blank" rel="noopener">View on Map</a>`
                : ''
            }
          </div>
        </div>
      </div>
    `;
  }

  async function refresh(){
    const list = await api.getProperties({});
    adminList.innerHTML = list.map(renderCard).join('');

    adminList.querySelectorAll('button[data-act="edit"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const p = list.find(x => x.id === id);
        if (p) fillForm(p);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    adminList.querySelectorAll('button[data-act="del"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this listing?')) return;
        await api.deleteProperty(btn.dataset.id);
        await refresh();
      });
    });
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = toPayload();

    if (!payload.title) {
      alert("Title is required.");
      return;
    }

    if (payload.id) {
      await api.updateProperty(payload.id, payload);
    } else {
      await api.createProperty(payload);
    }

    fillForm(null);
    await refresh();
    alert('Saved.');
  });

  resetBtn.addEventListener('click', () => fillForm(null));

  // Initial load
  fillForm(null);
  await refresh();
});
</script>
</body>
</html>
