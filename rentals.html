<!DOCTYPE html> 
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>340 Rentals VI – Rentals</title>
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header class="navbar">
  <div class="logo">340 Rentals VI</div>
  <nav>
    <a href="index.html" class="btn">Home</a>
    <a href="rentals.html" class="btn">Rentals</a>
    <a href="contact.html" class="btn">Contact</a>
    <a href="admin.html" class="btn" id="adminLink" style="display:none;">Manage Listings</a>


    <span id="userInfo" class="userInfo" style="display:none;"></span>
    <a id="loginBtn" class="btn" href="#" onclick="startLogin(event)">Owner Login</a>
    <a id="logoutBtn" class="btn" href="#" onclick="startLogout(event)" style="display:none;">Logout</a>
  </nav>
</header>


  <main class="content">
    <h1>Available Rentals</h1>

    <div class="filters">
      <input id="beds" type="number" placeholder="Min beds" />
      <input id="baths" type="number" step="0.5" placeholder="Min baths" />
      <input id="maxPrice" type="number" placeholder="Max price" />
      <label class="chk">
        <input id="onlyAvail" type="checkbox" /> Only available
      </label>
      <button id="apply" class="btn">Apply</button>
      <button id="clear" class="btn">Clear</button>
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <script src="script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const grid = document.getElementById('grid');
      const bedsInput = document.getElementById('beds');
      const bathsInput = document.getElementById('baths');
      const maxPriceInput = document.getElementById('maxPrice');
      const onlyAvailCheckbox = document.getElementById('onlyAvail');
      const applyBtn = document.getElementById('apply');
      const clearBtn = document.getElementById('clear');

      // Normalize photos/images into a clean array of URLs
      function normalizePhotos(p) {
        if (Array.isArray(p.photos)) {
          return p.photos.filter(Boolean);
        }
        if (typeof p.photos === 'string' && p.photos.trim()) {
          return p.photos.split(',').map(s => s.trim()).filter(Boolean);
        }
        if (Array.isArray(p.images)) {
          return p.images.filter(Boolean);
        }
        if (typeof p.images === 'string' && p.images.trim()) {
          return p.images.split(',').map(s => s.trim()).filter(Boolean);
        }
        return [];
      }

      // Hook up prev/next buttons on all carousels
      function setupCarousels() {
        const carousels = grid.querySelectorAll('.carousel[data-photos]');
        carousels.forEach(carousel => {
          const photos = JSON.parse(carousel.dataset.photos || '[]');
          if (!photos.length) return;

          let index = Number(carousel.dataset.index) || 0;
          const imgEl = carousel.querySelector('img');
          const prevBtn = carousel.querySelector('.carousel-btn.prev');
          const nextBtn = carousel.querySelector('.carousel-btn.next');

          function show(i) {
            index = (i + photos.length) % photos.length;
            carousel.dataset.index = index;
            imgEl.src = photos[index];
          }

          prevBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            show(index - 1);
          });

          nextBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            show(index + 1);
          });
        });
      }

      function render(list) {
        if (!list.length) {
          grid.innerHTML = '<p>No rentals match your filters.</p>';
          return;
        }

        grid.innerHTML = list.map(p => {
          const photos = normalizePhotos(p);
          const photosAttr = photos.length
            ? JSON.stringify(photos).replace(/"/g, '&quot;')
            : '[]';

          const hasPhotos = photos.length > 0;

          const address = p.address || '';
          const city = p.city || '';
          const mapQuery = (address || city).trim();
          const hasMap = mapQuery.length > 0;
          const mapLink = hasMap
            ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapQuery)}`
            : '';

          const carouselHtml = hasPhotos
            ? `
          <div class="carousel" data-photos="${photosAttr}" data-index="0" style="position:relative;">
            <button class="carousel-btn prev" type="button"
              style="position:absolute;top:50%;left:8px;transform:translateY(-50%);
                     background:rgba(0,0,0,0.4);border:none;color:#fff;width:28px;height:28px;
                     border-radius:50%;cursor:pointer;font-size:18px;line-height:26px;">&#10094;</button>
            <img src="${photos[0]}" style="width:100%;height:180px;object-fit:cover;border-radius:10px 10px 0 0;">
            <button class="carousel-btn next" type="button"
              style="position:absolute;top:50%;right:8px;transform:translateY(-50%);
                     background:rgba(0,0,0,0.4);border:none;color:#fff;width:28px;height:28px;
                     border-radius:50%;cursor:pointer;font-size:18px;line-height:26px;">&#10095;</button>
          </div>`
            : `
          <div class="carousel">
            <div style="aspect-ratio:4/3;background:#eee;border-radius:10px 10px 0 0;"></div>
          </div>`;

          return `
        <div class="card">
          ${carouselHtml}
          <div class="card-body" style="padding:0.75rem 1rem;">
            <div class="title-row">
              <div style="font-weight:600;">${p.title || ''}</div>
              <div class="price">$${Number(p.price || 0).toLocaleString()}</div>
            </div>
            <div class="meta">
              ${p.bedrooms || 0} bd • ${p.bathrooms || 0} ba
              ${p.city ? ' • ' + p.city : ''}
            </div>
           ${address
              ? `<div style="font-size:12px;color:#666;margin-top:2px;">${address}</div>`
              : city
                ? `<div style="font-size:12px;color:#666;margin-top:2px;">${city}</div>`
                : ''
            }

            <div style="margin-top:4px;">
              <span class="status ${p.available ? 'available' : 'unavailable'}">
                ${p.available ? 'Available' : 'Unavailable'}
              </span>
            </div>
            <p style="font-size:14px;color:#555;margin:.5rem 0 0;">
              ${p.description || ''}
            </p>
            <div class="card-actions" style="margin-top:0.5rem;">
              ${mapLink
                ? `<a class="btn" href="${mapLink}" target="_blank" rel="noopener">View on Map</a>`
                : ''
              }
            </div>
          </div>
        </div>
      `;
        }).join('');

        // After we dump the HTML, wire up the carousels
        setupCarousels();
      }

      async function loadAndFilter() {
        const all = await api.getProperties({});
        const minBeds = Number(bedsInput.value) || 0;
        const minBaths = Number(bathsInput.value) || 0;
        const priceCap = maxPriceInput.value ? Number(maxPriceInput.value) : Infinity;
        const onlyAvail = onlyAvailCheckbox.checked;

        const filtered = all.filter(p =>
          (p.bedrooms || 0) >= minBeds &&
          (p.bathrooms || 0) >= minBaths &&
          Number(p.price || 0) <= priceCap &&
          (!onlyAvail || p.available)
        );

        render(filtered);
      }

      applyBtn.addEventListener('click', loadAndFilter);
      clearBtn.addEventListener('click', () => {
        bedsInput.value = '';
        bathsInput.value = '';
        maxPriceInput.value = '';
        onlyAvailCheckbox.checked = false;
        loadAndFilter();
      });

      await loadAndFilter();
    });
  </script>
</body>

</html>
